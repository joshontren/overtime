<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>
  <link rel="stylesheet" href="/styles.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    .user-summary {
      cursor: pointer;
      border: 1px solid #dee2e6;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 5px;
    }
    .user-summary:hover {
      background-color: #e9ecef;
    }
    .request-history {
      display: none;
      margin-left: 20px;
    }
    .highlight-orange {
      background-color: #ffa500; /* Orange */
    }
    .highlight-green {
      background-color: #90ee90; /* Green */
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Overtime Scheduler</a>
      <div class="navbar-nav ms-auto">
        <a class="nav-link" href="/logout">Logout</a>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <h1 class="text-center">Welcome, <%= user.username %>!</h1>
    <h4 class="text-center"> <%= user.role %></h4>

    <!-- Employee/Supervisor: Create Request Form -->
    <% if (user.role === 'employee' || user.role === 'supervisor') { %>
      <div class="card p-4 shadow mt-3">
        <h2>Create a Request</h2>
        <form action="/requests" method="POST">
          <div class="mb-3">
            <input type="text" name="site" class="form-control" placeholder="Site" required>
          </div>
          <div class="mb-3">
            <input type="text" name="duty" class="form-control" placeholder="Duty" required>
          </div>
          <div class="mb-3">
            <input type="text" name="vehicle" class="form-control" placeholder="Vehicle" required>
          </div>
          <div class="mb-3">
            <label>Time In:</label>
            <input type="datetime-local" name="timeIn" class="form-control" required>
          </div>
          <div class="mb-3">
            <label>Time Out:</label>
            <input type="datetime-local" name="timeOut" class="form-control" required>
          </div>
          <button type="submit" class="btn btn-primary w-100">Submit Request</button>
        </form>
      </div>
    <% } %>

    <!-- Overtime Summary -->
    <h2 class="mt-4">Overtime Summary</h2>
    <table class="table table-striped">
      <thead>
        <tr>
          <th>User</th>
          <th>Previous Month Work Hours</th>
          <th>Previous Month Pay Hours</th>
          <th>Current Month Work Hours</th>
          <th>Current Month Pay Hours</th>
          <th>Total Paid Hours</th>
        </tr>
      </thead>
      <tbody>
        <% if (user.role === 'admin' || user.role === 'supervisor' || user.role === 'ceo') { %>
          <!-- Admins, Supervisors, and CEO: Show all users -->
          <% for (const userId in requestsByUser) { %>
            <tr>
              <td><%= requestsByUser[userId].username %></td>
              <td><%= requestsByUser[userId].previousMonthWorkHours.toFixed(2) %></td>
              <td><%= requestsByUser[userId].previousMonthPayHours.toFixed(2) %></td>
              <td><%= requestsByUser[userId].currentMonthWorkHours.toFixed(2) %></td>
              <td><%= requestsByUser[userId].currentMonthPayHours.toFixed(2) %></td>
              <td><%= requestsByUser[userId].totalPaidHours.toFixed(2) %></td>
            </tr>
          <% } %>
        <% } else { %>
          <!-- Employees: Show only their own data -->
          <tr>
            <td><%= requestsByUser[user._id].username %></td>
            <td><%= requestsByUser[user._id].previousMonthWorkHours.toFixed(2) %></td>
            <td><%= requestsByUser[user._id].previousMonthPayHours.toFixed(2) %></td>
            <td><%= requestsByUser[user._id].currentMonthWorkHours.toFixed(2) %></td>
            <td><%= requestsByUser[user._id].currentMonthPayHours.toFixed(2) %></td>
            <td><%= requestsByUser[user._id].totalPaidHours.toFixed(2) %></td>
          </tr>
        <% } %>
      </tbody>
    </table>

    <!-- Request History -->
    <h2 class="mt-4">Request History</h2>
    <% if (user.role === 'admin' || user.role === 'supervisor' || user.role === 'ceo') { %>
      <!-- Admins, Supervisors, and CEO: Show all users' requests -->
      <% for (const userId in requestsByUser) { %>
        <!-- Check if any action is required for the current user's role -->
        <% const requiresAction = requestsByUser[userId].requests.some(request => { 
          if (user.role === 'supervisor' && request.status === 'pending') return true;
          if (user.role === 'admin' && request.status === 'supervisor-approved') return true;
          if (user.role === 'ceo' && request.status === 'admin-approved' && !request.ceoSignOff) return true;
          return false;
        }); %>
        <div class="user-summary <%= requiresAction ? 'highlight-orange' : 'highlight-green' %>" onclick="toggleRequests('<%= userId %>')">
          <strong><%= requestsByUser[userId].username %></strong>
        </div>
        <div id="requests-<%= userId %>" class="request-history">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Created By</th>
                <th>Site</th>
                <th>Duty</th>
                <th>Vehicle</th>
                <th>Time In</th>
                <th>Time Out</th>
                <th>Total Hours</th>
                <th>Work Hours</th>
                <th>Pay Hours</th>
                <th>Status</th>
                <th>CEO Sign-Off</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% requestsByUser[userId].requests.forEach(request => { %>
                <tr>
                  <td><%= request.createdBy ? request.createdBy.username : 'N/A' %></td>
                  <td><%= request.site %></td>
                  <td><%= request.duty %></td>
                  <td><%= request.vehicle %></td>
                  <td><%= request.timeIn.toLocaleString() %></td>
                  <td><%= request.timeOut.toLocaleString() %></td>
                  <td><%= request.totalHours.toFixed(2) %></td>
                  <td><%= request.totalHours.toFixed(2) %></td> <!-- Work Hours (same as total hours) -->
                  <td>
                    <!-- Calculate Pay Hours based on day of the week -->
                    <% 
                      const requestDate = new Date(request.timeIn);
                      const dayOfWeek = requestDate.getDay(); // 0 = Sunday, 6 = Saturday
                      let payHours = request.totalHours;

                      if (dayOfWeek === 0) {
                        // Sunday: 2x multiplier
                        payHours = request.totalHours * 2;
                      } else if (dayOfWeek === 6) {
                        // Saturday: 1.5x multiplier
                        payHours = request.totalHours * 1.5;
                      }
                    %>
                    <%= payHours.toFixed(2) %>
                  </td>
                  <td><%= request.status %></td>
                  <td><%= request.ceoSignOff ? 'Yes' : 'No' %></td>
                  <td>
                    <% if (user.role === 'supervisor' && request.status === 'pending') { %>
                      <!-- Supervisor: Approve button -->
                      <form action="/requests/<%= request._id %>/supervisor-approve" method="POST" class="d-inline">
                        <button type="submit" class="btn btn-success">Approve</button>
                      </form>
                    <% } else if (user.role === 'admin' && request.status === 'supervisor-approved') { %>
                      <!-- Admin: Approve button -->
                      <form action="/requests/<%= request._id %>/admin-approve" method="POST" class="d-inline">
                        <button type="submit" class="btn btn-success">Approve</button>
                      </form>
                    <% } else if (user.role === 'ceo' && request.status === 'admin-approved' && !request.ceoSignOff) { %>
                      <!-- CEO: Sign Off button -->
                      <form action="/requests/<%= request._id %>/ceo-signoff" method="POST" class="d-inline">
                        <button type="submit" class="btn btn-warning">Sign Off</button>
                      </form>
                    <% } %>
                    <% if (user.role === 'ceo') { %>
                      <!-- CEO: Edit button -->
                      <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editRequestModal-<%= request._id %>">
                        Edit
                      </button>
                    <% } %>
                  </td>
                </tr>

                <!-- Edit Request Modal -->
                <div class="modal fade" id="editRequestModal-<%= request._id %>" tabindex="-1" aria-labelledby="editRequestModalLabel" aria-hidden="true">
                  <div class="modal-dialog">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="editRequestModalLabel">Edit Request</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body">
                        <form action="/requests/<%= request._id %>/edit" method="POST">
                          <div class="mb-3">
                            <label>Site:</label>
                            <input type="text" name="site" class="form-control" value="<%= request.site %>" required>
                          </div>
                          <div class="mb-3">
                            <label>Duty:</label>
                            <input type="text" name="duty" class="form-control" value="<%= request.duty %>" required>
                          </div>
                          <div class="mb-3">
                            <label>Vehicle:</label>
                            <input type="text" name="vehicle" class="form-control" value="<%= request.vehicle %>" required>
                          </div>
                          <div class="mb-3">
                            <label>Time In:</label>
                            <input type="datetime-local" name="timeIn" class="form-control" value="<%= request.timeIn.toISOString().slice(0, 16) %>" required>
                          </div>
                          <div class="mb-3">
                            <label>Time Out:</label>
                            <input type="datetime-local" name="timeOut" class="form-control" value="<%= request.timeOut.toISOString().slice(0, 16) %>" required>
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>
                </div>
              <% }) %>
            </tbody>
          </table>
        </div>
      <% } %>
    <% } else { %>
      <!-- Employees: Show only their own requests -->
      <div class="user-summary highlight-green" onclick="toggleRequests('<%= user._id %>')">
        <strong><%= requestsByUser[user._id].username %></strong>
      </div>
      <div id="requests-<%= user._id %>" class="request-history">
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Created By</th>
              <th>Site</th>
              <th>Duty</th>
              <th>Vehicle</th>
              <th>Time In</th>
              <th>Time Out</th>
              <th>Total Hours</th>
              <th>Work Hours</th>
              <th>Pay Hours</th>
              <th>Status</th>
              <th>CEO Sign-Off</th>
            </tr>
          </thead>
          <tbody>
            <% requestsByUser[user._id].requests.forEach(request => { %>
              <tr>
                <td><%= request.createdBy ? request.createdBy.username : 'N/A' %></td>
                <td><%= request.site %></td>
                <td><%= request.duty %></td>
                <td><%= request.vehicle %></td>
                <td><%= request.timeIn.toLocaleString() %></td>
                <td><%= request.timeOut.toLocaleString() %></td>
                <td><%= request.totalHours.toFixed(2) %></td>
                <td><%= request.totalHours.toFixed(2) %></td> <!-- Work Hours (same as total hours) -->
                <td>
                  <!-- Calculate Pay Hours based on day of the week -->
                  <% 
                    const requestDate = new Date(request.timeIn);
                    const dayOfWeek = requestDate.getDay(); // 0 = Sunday, 6 = Saturday
                    let payHours = request.totalHours;

                    if (dayOfWeek === 0) {
                      // Sunday: 2x multiplier
                      payHours = request.totalHours * 2;
                    } else if (dayOfWeek === 6) {
                      // Saturday: 1.5x multiplier
                      payHours = request.totalHours * 1.5;
                    }
                  %>
                  <%= payHours.toFixed(2) %>
                </td>
                <td><%= request.status %></td>
                <td><%= request.ceoSignOff ? 'Yes' : 'No' %></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    <% } %>
  </div>

  <!-- Watermark -->
  <div class="watermark">Dedomena Solutions © 2025</div>

  <script>
    function toggleRequests(userId) {
      const requestHistory = document.getElementById(`requests-${userId}`);
      if (requestHistory.style.display === 'none' || requestHistory.style.display === '') {
        requestHistory.style.display = 'block';
      } else {
        requestHistory.style.display = 'none';
      }
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>